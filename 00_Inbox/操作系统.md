## 进程管理

### 进程、线程基础知识

#### 进程

编写的代码通过编译后生成二进制可执行文件，当运行这个文件后，它会被装载到内存中，接着CPU会执行程序中的每一条指令，这个运行中的程序就称为**进程**。

如果现在有一个会读取硬盘文件数据的程序被执行了，那么运行到读取文件指令时，因为硬盘读写速度非常慢，CPU不需要阻塞等待数据返回，而是去执行另外的进程。直到硬盘数据返回时，CPU会收到**中断**，然后再继续运行这个进程。

![[4-进程交替运行.webp]]

这种**多个程序、交替执行**的思想，就有CPU管理多个进程的初步想法。

对于一个支持多进程的系统，CPU会从一个进程快速切换到另一个进程，期间每个进程各运行几十或几百毫秒。

虽然单核的CPU在某一瞬间只能运行一个进程，但在一秒钟期间，它可能运行多个进程，这就产生了**并行的错觉**，也就是**并发**。

> 并行和并发有什么区别？

![[5-并发与并行.webp]]

CPU可以从一个进程切换到另一个进程，在切换之前必须记录当前进程中运行的信息，以备下次切换回来时可以恢复执行。

#### 线程

早期操作系统都是以进程作为独立运行的基本单位，后面又提出了更小的能独立运行的基本单位，也就是**线程**。

##### 什么是线程

**线程是进程中的一条执行流程。**

同一个进程内多个线程之间可以共享代码段、数据段、打开的文件等资源，但每个线程各自都有一套独立的寄存器和栈，这样可以确保线程的控制流是相对独立的。

线程的优点：

1. 一个进程中可以同时存在多个线程。
2. 各个线程之间可以并发执行。
3. 各个线程之间可以共享地址空间和文件等资源。

线程的缺点：

当进程中的一个线程崩溃时，会导致其所属进程的所有线程崩溃。

##### 线程和进程的比较

- 进程是资源分配的基本单位，线程是CPU调度的单位。
- 进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和栈。
- 线程同样具有就绪、阻塞、执行三种基本状态，同样具有状态之间的转换关系。
- 线程能减少并发执行的时间和空间开销。

线程减少开销体现在：

- 线程创建的更快，进程在创建时需要资源管理信息，如内存管理信息、文件管理信息等，线程则不需要，它是共享进程拥有的这些信息的。
- 线程的终止时间更快，因为线程释放的资源比进程少很多。
- 同一个进程内的线程切换比进程切换快，因为线程具有相同的地址空间。同一个进程的线程都具有同一个页表，在切换时不需要切换页表。而进程的切换，需要切换页表，开销很大。
- 因为同一个进程的各个线程间共享内存和文件资源，在线程之间数据传递时不需要经过内核，使得线程之间的数据交互效率更高。

### 进程间的通信方式

#### 管道

管道是内核里的一串缓存。从管道写入一段数据，实际上是缓存在内核中的，另一端读取也是从内核读取。

**对于匿名管道，它的通信范围是存在父子关系的进程**。因为管道没有实体，也就是没有管道文件，只能通过 fork 来复制父进程 fd 文件描述符，来达到通信的目的。

**对于命名管道，它可以在不相关的进程间也能相互通信**。因为命令管道，提前创建了一个类型为管道的设备文件，在进程里只要使用这个设备文件，就可以相互通信。

不管是匿名管道还是命名管道，进程写入的数据都是缓存在内核中，另一个进程读取数据时候自然也是从内核中获取，同时通信数据都遵循**先进先出**原则，不支持 lseek 之类的文件定位操作。

#### 消息队列

因为管道的通信方式效率低，所以管道不适合进程间频繁地交换数据。

**消息队列**的通信模式就可以解决这个问题。比如，A 进程要给 B 进程发送消息，A 进程把数据放在对应的消息队列后就可以正常返回了，B 进程需要的时候再去读取数据就可以了。同理，B 进程要给 A 进程发送消息也是如此。

另外，消息队列是保存在内核中的消息链表，在发送数据时，会分成一个个独立的数据单元，也就是消息体，消息体是用户自定义的数据类型，消息的发送方和接收方要约定好消息体的数据类型，所以每个消息体都是固定大小的存储块，不像管道是无格式字节流数据。如果进程从消息队列中读取了消息体，内核就会把该消息体删除。

两个进程之间的通信就像发邮件一样，所以消息队列通信有这两个缺点：一是**通信不及时**，二是**附件有大小限制**。

消息队列不适合大数据传输，在通信过程中存在用户态与内核态之间的数据拷贝开销。

#### 共享内存




