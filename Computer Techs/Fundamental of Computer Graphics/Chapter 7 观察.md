几何变换的另一个重要用途就是让物体在三维位置和它们在三维世界的二维投影中的位置之间移动，这种从三维到二维的映射叫做视图变换，它在物体顺序渲染中扮演着重要角色，物体顺序渲染指的是迅速地找到场景中每一个物体的图像空间位置。

本章中的变换将场景中的三维点（世界空间）投影到图像中的二维点（图像空间），这些变换还将在一个给定像素的观察射线上的任何点投影回该像素在图像空间中的位置。

仅凭将世界中的点投影到图像上的能力，只适用于生成**线框**渲染——只绘制物体的边缘且近处物体不会遮挡远处物体。就像光线追踪器所做的那样，显示实心外观物体的物体顺序渲染器也必须计算在屏幕上特定点上的哪一个表面更近并只显示它。

在本章中，我们假定绘制的模型仅由3D线段组成。

## 视图变换

视图变换的职责是将标准坐标系中表示为$(x,y,z)$的3D位置映射到图像空间坐标，这是一个由很多不同东西决定的过程，包括摄像机位置和朝向，投影类型，视角范围，以及图像分辨率。

大多数图形系统通过使用这样的三个变换的序列来完成视图变换：

- 摄像机变换：将摄像机以一个方便的朝向放置在原点，是一种刚体变换，只取决于摄像机的位置和朝向。
- 投影变换：投影摄像机空间中的点，让所有可见点的x和y落在-1到1范围，只取决于投影类型。
- 视口变换：将单位图像矩形映射到像素坐标中的期望矩形上，只取决于输出图像的尺寸和位置。

![[Pasted image 20250616163007.png]]

摄像机变换将标准坐标系（**世界空间**）下的点转换到**摄像机空间**，投影变换将点从摄像机空间移动到**规范观察体**中，最终视口变换将点从规范观察体映射到**屏幕空间**。

> [!NOTE] 其他名称
> 摄像机空间也叫做眼睛空间；规范观察体也叫做裁剪空间或规范化设备坐标；屏幕空间也叫做像素坐标。

### 视口变换

假设我们想观察的几何体位于规范观察体中，并使用一个看向$-z$方向的正交摄像机。

规范观察体是一个包含所有三维点的立方体，任何点$(x,y,z)\in [-1,1]^3$，它将$x=-1$投影到屏幕左边，将$x=+1$投影到屏幕右边，将$y=-1$投影到屏幕底部，将$y=+1$投影到屏幕顶部。

![[Pasted image 20250616170656.png]]

由于像素中心位于整数坐标上，图像边界会超出像素中心半个单位，而且最小的像素中心坐标为$(0,0)$，如果我们在一张$n_x\times n_y$的图像上绘制，则需要将正方形$[-1,1]^2$映射到矩形$[-0.5,n_x-0.5]\times [-0.5,n_y-0.5]$。

$$
\left[\begin{matrix}
x_{screen} \\ y_{screen} \\ 1
\end{matrix}\right]=
\left[\begin{matrix}
\frac{n_x}{2} & 0 & \frac{n_x-1}{2} \\
0 & \frac{n_y}{2} & \frac{n_y-1}{2} \\
0 & 0 & 1
\end{matrix}\right]
\left[\begin{matrix}
x_{canonical} \\ y_{canonical} \\ 1
\end{matrix}\right]
$$

注意到该矩阵忽略了点的z坐标，这是因为一个点在投影方向上的距离并不影响点在图像上的投影位置。不过在将其称为视口变换矩阵之前，我们还是会添加一行一列来保持z坐标不变。

$$
M_{vp}=
\left[\begin{matrix}
\frac{n_x}{2} & 0 & 0 & \frac{n_x-1}{2} \\
0 & \frac{n_y}{2} & 0 & \frac{n_y-1}{2} \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \\
\end{matrix}\right]
$$

### 正交投影变换

当然，我们通常希望在空间中的某个范围而不是规范观察体中渲染几何体。为了使这种观察更加普适化，我们将保持观察方向和$-z$朝向，$+y$轴向上，但允许观察任意矩形。

在这些约束下，观察体是一个轴对齐盒子，$[l,r]\times[b,t]\times[f,n]$观察体如下图。

![[Pasted image 20250616171905.png]]

我们将该盒子称为**正交观察体**，其边界平面如下：

$$
\begin{align}
&x=l\equiv left\ plane\\
&x=r\equiv right\ plane\\
&y=b\equiv bottom\ plane\\
&y=t\equiv top\ plane\\
&z=n\equiv near\ plane\\
&z=f\equiv far\ plane
\end{align}
$$

![[Pasted image 20250616172311.png]]

从正交观察体到规范观察体的变换矩阵：

$$
M_{orth}=
\left[\begin{matrix}
\frac{2}{r-l} & 0 & 0 & -\frac{r+l}{r-l} \\
0 & \frac{2}{t-b} & 0 & -\frac{t+b}{t-b} \\
0 & 0 & \frac{2}{n-f} & -\frac{n+f}{n-f} \\
0 & 0 & 0 & 1 \\
\end{matrix}\right]
$$

为了在正交观察体中绘制3D线段，我们将其投影到屏幕x-y坐标并忽略z坐标。

$$
\left[\begin{matrix}
x_{pixel} \\ y_{pixel} \\ z_{canonical} \\ 1
\end{matrix}\right]=
(M_{vp}M_{orth})
\left[\begin{matrix}
x \\ y \\ z \\ 1
\end{matrix}\right]
$$

z坐标会位于$[-1,1]$，在我们实现z-buffer算法时它会很有用。

于是，绘制许多端点为$a_i$和$b_i$的线段变得简单且有效率：

![[Pasted image 20250616175543.png]]

### 摄像机变换

我们希望能够改变视点和观察方向，指定观察者位置和朝向的惯例做法有很多，我们将使用以下这个：

- 眼睛位置：$e$
- 注视方向：$g$
- 视野上方向量：$t$

![[Pasted image 20250618171357.png]]

如果把图形学视为一个摄影的过程，眼睛位置就是镜头的中心，注视方向即观察者看向的任意方向向量，视野上方向量即观察者头顶指向天空的方向向量。这些向量为我们建立一个以$e$为原点、$uvw$为基的坐标系统提供了充足的信息。

$$
\begin{align}
&w=-\frac{g}{||g||},\\
&u=\frac{t\times w}{||t\times w||},\\
&v=w\times u.
\end{align}
$$

接下来只要把世界空间坐标变换到摄像机空间中就完成了，利用规范系到摄像机坐标系的变换矩阵：

$$
M_{cam}=\left[\begin{matrix}
u & v & w & e \\
0 & 0 & 0 & 1
\end{matrix}\right]^{-1}
$$

可以认为该变换首先将$e$移动到原点，然后使$u,v,w$对齐$x,y,z$。

为了让之前的仅z轴观察算法对任意位置和朝向的摄像机都生效，我们只需要将该摄像机变换添加到视口和投影变换的乘积中，使点在被投影之前先变换到摄像机空间。

![[Pasted image 20250618174237.png]]

## 投影变换

对于位于原点看向$-z$轴的眼睛来说，透视的关键特性在于屏幕上的物体大小是和$1/z$成比例的，通过以下等式和图例可以更精确地说明这一点：

$$
y_s=\frac{d}{z}y
$$

![[Pasted image 20250618175033.png]]

我们想利用已经得到的正交投影算法来绘制透视图像，也就是说只需要把另一个矩阵乘进之前的组合矩阵中。但是这种类型的变换——输入向量的其中一个坐标出现在分母，是无法通过仿射变换得到的。

一个点$(x,y,z)$用齐次向量表示为$[x\ y\ z\ 1]^T$，通过将仿射变换矩阵的第四行始终指定为$[0\ 0\ 0\ 1]^T$，可以确保点的齐次向量的$w$分量始终为1。

我们不一定只用“1”来实现平移变换，可以将它定义为$xyz$坐标的分母，那么齐次向量$[x\ y\ z\ w]^T$也可以表示为点$(x/w,y/w,z/w)$，这样允许变换矩阵的最后一行的w分量可以是任意值。

线性变换允许我们计算这样的表达式：

$$
x'=ax+by+cz
$$

而仿射变换将它拓展为：

$$
x'=ax+by+cz+d
$$

把$w$看作$xyz$的分母进一步扩展了更多可能性，让我们可以计算这样的表达式：

$$
x'=\frac{ax+by+cz+d}{ex+fy+gz+h}
$$

它被称为一个$x,y,z$的线性有理函数。而且还有一个额外的约束，被变换点的所有坐标的分母都是相同的。






