计算机图形最基本的任务之一就是渲染三维物体：选取一个由许多3D空间下的几何物体组成的场景或模型，然后产生一张从特定视角观察这些物体的2D图像。

本质上，渲染就是将一个物体集合作为输入并输出一个像素数组的过程。无论如何，渲染涉及到考虑每个物体对单个像素的贡献值，其实现方式可分为两种：

1. **物体顺序（object-order）渲染**：依次遍历每个物体，针对当前物体定位其影响的所有像素并更新像素值；
2. **图像顺序（image-order）渲染**：依次遍历每个像素，针对当前像素定位影响它的所有物体并计算最终像素值。

光线追踪是一个图像顺序的算法。

## 基本光线追踪算法

光线追踪器每次计算一个像素，其基本任务是找到对应像素位置上能看到的物体。每个像素“看向”不同的方向，任何被一个像素看到的物体必定和**视线**相交，视线从视点发出，其方向和该像素的朝向一致。我们想要找的物体就是与视线相交的最接近摄像机的那个，因为它挡住了在它后面物体的视野。一旦找到了这个物体，就会利用相交点、表面法线和其他必要信息来进行**着色**计算，以确定像素的颜色。

一个基本的光线追踪器包含三部分：

1. 光线生成：计算每一个像素基于相机几何的视线的原点和方向
2. 光线相交：找到和视线相交的最近物体
3. 着色：基于光线相交结果计算像素颜色

基本的光线追踪程序结构：

```
for each pixel do
	compute view ray
	find first object hit by ray and its surface normal n
	set pixel color to value computed from hit point, light, and normal
```

## 透视

早在计算机出现的几百年之前，艺术家们就已经研究过如何将3D物体或场景用2D绘图展现出来这个问题了。不管是艺术、摄影，还是计算机图形，普遍的做法都是**线性透视**——3D物体被投影到一个图像平面上，场景中的直线到了图像中还是直线。

**平行投影**是最简单的投影，常用于机械和建筑绘图。在这种方式中，3D点通过沿着一个**投影方向**移动到图像平面从而映射到2D。其产生的画面由投影方向和图像平面决定，如果图像平面与观察方向垂直，称为**正交的**，否则为**倾斜的**。

![[Pasted image 20250612114531.png]]

![[Pasted image 20250612114553.png]]

就我们的日常经验而言，在远处的物体看起来会更小，这也导致当平行的线向远处退去时，看起来就不平行了。这是因为人眼和摄像机不会从单一的视角收集光线，而是收集穿过一个特定视点的光线。自从文艺复兴时期，艺术家们就已经意识到了这一点，我们可以通过**透视投影**创造出看起来自然的景象，其做法就是沿着穿过视点的线而非平行线做投影。

透视视图由视点的选择和图像平面决定，和平行视图一样有倾斜的和非倾斜的透视视图（基于在图像中心的投影方向造成的区别）。

**三点透视**是美术中用于手动构造透视视图的一个传统方法，如果我们遵循这个基本的数学原则，即物体直接朝向眼睛投影，并且它们在前方的视平面上相遇的地方被绘制出来，那么所有的透视绘画规则都会自动得到遵守。

![[Pasted image 20250612114105.png]]

> [!NOTE]
> 在三点透视中，每一组平行线会汇聚到各自的消失点，例如横向平行线会在地平线上的某个点相遇。

## 计算视线

为了生成射线，首先需要一个射线的数学表示。一条射线实际上就是一个原点和一个延伸方向，用3D参数化直线非常适合。从眼睛$e$到图像平面上$s$点的3D参数化直线表示为$p(t)=e+t(s-e)$，它可以解释为：从$e$出发沿着向量$(s-e)$延伸部分距离$t$到达$p$点。如果$0<t_1<t_2$，那么$p(t_1)$比$p(t_2)$更靠近眼睛，如果$t<0$，那么$p(t)$就在眼睛后面，这些结论在搜索被射线击中且不位于眼睛后方的最近物体时非常有用。

为了计算视线，我们需要知道$e$（已知）和$s$，如果我们在正确的坐标系下看待这个问题，实际上就能直接找到$s$了。

所有的射线生成方法都出发于一个叫做摄像机坐标系的标准正交基，将眼睛位置或视点表示为$e$，$u$（指向右方）、$v$（指向上方）和$w$（指向后方）为三个基向量，$\{u,v,w\}$形成了一个右手坐标系。

构建摄像机坐标系最普遍的做法如图。

![[Pasted image 20250612151539.png]]

### 正交视图

对于正交视图，所有射线的方向都是$-w$。即使平行视图本质上并没有一个视点，我们仍然可以使用摄像机空间来定义射线起始的平面，因此物体是有可能在摄像机背后的。

视线应该从由点$e$和向量$u$和$v$定义的平面起始，剩余的必要信息就是：图像应该位于平面上的哪个地方。我们用4个数字定义图像的规模，分别对应图像的4条边：$l$和$r$为图像的左右边缘，从$e$沿着$u$方向测量得到；$b$和$t$为图像的下上边缘，从$e$沿着$v$方向测量得到。通常$l<0<r,\ b<0<t$。

为了将一张$n_x\times n_y$个像素的图像放进大小为$(r-l)\times (t-b)$的矩形中，像素之间的横向间距为$(r-l)/n_x$，纵向间距为$(t-b)/n_y$，在边缘周围留出半个像素的空间，以使像素网格在图像矩形上居中，那么在光栅图像中位于$(i,j)$的像素的位置为：

$$
\begin{align}
u=l+(r-l)(i+0.5)/n_x,\\
v=b+(t-b)(j+0.5)/n_y.
\end{align}
$$

$(u,v)$是像素在图像平面上的坐标，相对于原点$e$和$\{u,v\}$基。

在正交视图中，我们可以简单地将像素的图像平面位置作为射线的起始点，而且我们已经知道射线的方向就是视角方向。那么生成正交视线的过程为：

$$
\begin{align}
&compute\ \mathbf{u}\ and\ \mathbf{v}\\
&ray.direction\leftarrow -\mathbf{w}\\
&ray.origin\leftarrow \mathbf{e}+u\mathbf{u}+v\mathbf{v}
\end{align}
$$
> [!NOTE]
> 同时指定$l$和$r$是冗余的，因为将视点向右移动一点或者对应地减小$l$和$r$都不会改变视图，在$v$轴上也是同样的。

### 透视视图

对于透视视图，所有射线的起点都是视点，而每个像素的视线方向是不同的。图像平面不再位于$e$，而是在$e$的前方一定距离$d$，该距离是**图像平面距离**，因为这个距离就和真实相机上的焦距一样，所以它也被称为**焦距**。

![[Pasted image 20250612174940.png]]

每条射线的方向由视点和像素在图像平面上的位置所决定，整个过程和正交视图是类似的：

$$
\begin{align}
&compute\ \mathbf{u}\ and\ \mathbf{v}\\
&ray.direction\leftarrow -d\mathbf{w}+u\mathbf{u}+v\mathbf{v}\\
&ray.origin\leftarrow \mathbf{e}
\end{align}
$$









