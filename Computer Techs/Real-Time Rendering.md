# 图形渲染管线

渲染管线的核心功能：利用给定的虚拟相机、三维物体、光源等信息，生成或渲染一张二维图像。

## 渲染管线的架构

图形渲染其实采用了流水线的思想。

流水线中有多个阶段，每个阶段有不同的任务，各个阶段可以并行执行。

流水线的整体效率受执行速度最慢的阶段所影响。

可以将实时渲染分为四个阶段：应用阶段、几何处理阶段、光栅化阶段、像素处理阶段。

渲染速度可以用每秒帧数（FPS）来表示，也可用赫兹（Hz）表示。

生成每帧图像花费的时间往往不同，取决于每帧中执行的计算的复杂度。

FPS可以用来表示某一帧的速率，也可以表示一段时间内的平均性能；Hz一般被设定为一个固定值，多用于硬件设备中。

## 应用阶段

应用阶段通常在CPU上运行，开发者可以完全控制。

需要渲染的几何物体会被输入到几何处理阶段中，这些几何物体称为渲染图元，即点、线、三角形。

该阶段中通常还会处理碰撞检测和处理硬件输入等操作。

## 几何处理阶段

几何处理阶段负责大部分的逐三角形和逐顶点操作，细分下去还可以划分为顶点着色、投影、裁剪和屏幕映射阶段。

### 顶点着色

顶点着色的任务主要有两个，一是计算顶点位置，二是计算顶点着色器输出的参数，例如法线和纹理坐标等。

计算顶点位置时，需要一组顶点坐标（模型空间）作为输入，经过模型变换后，得到世界空间坐标，再进行观察变换，得到观察空间坐标。

确定光照作用在材质上的效果的操作称为着色，通常一些计算在几何处理阶段进行，其他计算在逐像素处理时进行。

顶点着色的结果会传递到光栅化阶段中插值，在像素处理阶段中计算表面的着色。

投影和裁剪会将整个可视空间变换为一个标准立方体，中心位于坐标原点，边长为2。

**正交投影**的主要特征：投影变换前的平行线，在投影之后依然是平行的。投影变换由一个位移变换和一个缩放变换组成。

**透视投影**的主要特征：距离相机越远的物体，在投影变换之后就越小，平行线在投影之后会在视界处汇聚。

在投影变换之后，模型处于裁剪坐标系，在坐标除以w分量之前，它们都是齐次坐标。

### 可选的顶点处理

在完成顶点处理之后，还有几个可选的操作：曲面细分、几何着色、流式输出。

**曲面细分**的目的在于提高渲染质量，同时保证渲染效率。使用曲面细分可以为曲面生成数量合适的三角形，比如在离摄像机远时生成较少数量的三角形，近时生成较多的三角形。

曲面细分包含的子阶段：壳着色器，曲面细分器，域着色器。

**几何着色器**也是将各种类型的图元作为输入，然后生成新的顶点。常用于生成粒子，例如烟花，每个火花表示为一个顶点，然后转换成一个正方形，始终面向观察者，占据若干个像素，以便于后续的着色。

**流式输出**可以让我们把GPU作为一个几何引擎，将处理好的数据输入到一个缓冲区中，而不是直接输入到后续的渲染阶段并渲染出来。缓冲区中的数据可以被CPU读回使用，通常用于粒子模拟。

### 裁剪

只有完全位于可视空间内部或部分位于可视空间内部的图元，才需要发送到光栅化阶段进行处理。

对于一部分位于可视空间内部，一部分位于外部的图元，需要进行额外的裁剪操作，例如线段与空间边界的交点处会生成新的顶点来替代线段在空间外的顶点。

这里会使用投影变换生成的齐次坐标来完成裁剪，齐次坐标在透视空间中的三角形上插值通常不是线性的，需要使用齐次坐标的第四个值，一百年在透视投影之后进行正确的插值和裁剪。

最后进行透视除法，将得到的三角形位置转换到标准化设备坐标系中。

### 屏幕映射

输入该阶段的坐标是三维的，其中x和y坐标被转换成**屏幕坐标**，如果加上z坐标就称为**窗口坐标**。

## 光栅化阶段

光栅化阶段可以划分为两个子阶段：三角形设置，三角形遍历。

光栅化阶段是一个将屏幕空间中的二维顶点转换到屏幕上像素的过程，每个顶点对应一个z值（深度缓冲）和各种着色信息。

判断三角形和屏幕上哪些像素重合取决于如何GPU管线，例如可以使用**点采样**，直接将像素的中心点作为像素的样本，若该中心点位于三角形内部，就认为像素位于三角形内部。还可以使用**超采样**或**多重采样**抗锯齿技术，对每个像素进行多次采样。

### 三角形设置

该阶段计算三角形的微分、边界方程和其他数据，用于三角形遍历，以及对几何处理阶段产生的各种着色数据进行插值。

### 三角形遍历

该阶段会检查每一个被三角形覆盖的像素，生成一个对应的片元，并且对三角形三个顶点上的属性进行插值，来获得每个三角形片元的属性，包括片元深度以及相关着色数据等。

## 像素处理阶段

该阶段会对图元内部的像素进行逐像素的计算和操作，可以划分为像素着色和合并两个阶段。

### 像素着色

使用插值过的着色数据作为输入，进行逐像素的着色计算，最后生成一个或多个颜色值。

由可编程的GPU核心来执行，可以提供一个像素着色器的实现程序来进行着色计算。

### 合并

颜色缓冲存储了每个像素的颜色信息，该阶段会将片元的颜色组合起来。

合并阶段是高度可配置的，不是完全可编程的。

还负责解决片元可见性问题，通过深度缓冲实现。

深度缓冲和颜色缓冲尺寸相同，存储的是目前距离最近的图元z值，当渲染图元到某个像素上时，会计算图元z值，和深度缓冲中对应的像素深度进行比较，如果更小，说明离摄像机更近，应该更新深度缓冲和颜色缓冲。

# 图形处理单元

GPU是高度并行化的，处理速度非常快。

GPU使用专门的硬件来实现深度缓冲，能够快速访问纹理图像和其他缓冲区，以及快速寻找被一个三角形覆盖的像素。

