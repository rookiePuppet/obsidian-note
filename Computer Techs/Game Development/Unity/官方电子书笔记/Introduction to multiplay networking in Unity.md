# 基本概念

在多人游戏中，网络将玩家连接到一个中央服务器或直接相互连接，使他们可以实时共享数据和游玩。

典型的网络游戏架构由两部分组成，即客户端和服务器。

客户端是运行在玩家设备上的游戏实例，负责渲染游戏图像，播放音频，处理玩家输入，以及根据玩家动作发送更新到服务器。

服务器负责管理游戏状态，执行游戏规则，处理客户端之间的通信。服务器可以是由开发者运行的专用的无头机器，也可以是其中一个玩家的设备。

> [!NOTE] 无头服务器
> 指没有图形用户界面，专注于后端任务的服务器。因为它们不渲染图形，更易于扩展，经常部署在专用硬件或云环境中。

## UDP数据包

客户端和服务器之间使用标准网络协议如UDP（User Datagram Protocol），通过交换数据包进行通信。

UDP数据包由**头部**和**负载**（实际数据）两部分组成，负载包含额外的协议特定部分，每一部分也有它们自己的头部和负载，在网络术语中，这种嵌套叫做**封装**。

IP头部和UDP头部的大小固定，包含重要的元数据，如发送方和接收方的地址。而负载部分的大小、结构和内容不一，取决于特定游戏和上下文。

UDP在低延迟和速度方面有优势，但会缺少可靠性。由于UDP协议不提供任何在可靠性、顺序性、拥塞控制方面的机制，数据包在网络中传输时可能会发生以下错误：

- 数据包丢失：数据包有时可能会丢失，永远无法到达，可能是网络拥塞、硬件出错或其他原因导致。
- 重复：同一个数据包可能被接收方多次接收，可能由配置错误的网络硬件或软件导致。
- 重新排序：数据包可能以和发送时不同的顺序到达接收方，可能是因为数据包的传输路径和延迟不同
- 损坏：数据包在传输过程中可能被修改，导致数据不可用

## UDP对比TCP

网络协议是一套规定数据在网络中如何发送和接收的规则和约定，定义了如何建立连接，格式化信息，处理错误和传输数据。

在游戏开发中，UDP因为其快速和轻量的性质，一般更优于TCP（Transmission Control Protocol）。TCP对于网页浏览来说更加可靠适合，因为它能够重发丢失或失序的数据包，从而确保数据顺序性。

UDP为了考虑实时性能，容忍一定的数据丢失，从而获得更高的帧率。UDP也能够在响应性和偶尔的数据丢失之间取得平衡，是多人联机游戏的理想选择。

以下技术能够缓解UDP的不可靠性，和TCP的内置功能不同的是，这些技术可以在实际应用中进行微调。

| 技术               | 描述                                                                    |
| ---------------- | --------------------------------------------------------------------- |
| 序列号              | 每一个数据包都有一个唯一，递增的序列号，接收方利用它来监测数据包丢失和失序                                 |
| 接收确认（ACK）和接收确认掩码 | 数据包中包含最后一次接收到的数据包的序列号，使发送方知道哪些数据已经被成功接收。确认掩码可以同时追踪多个数据包的状态，更快地检测数据包丢失 |
| 超时重传调整（RTO）      | 类似于TCP用于测量数据往返时间的技术，往返时间可以用来调整客户端侧插值或预测                               |
| 超时设定             | 如果在一个特定时间内没有收到确认，则视为数据包丢失                                             |
