# URP中的灯光

## 渲染器的选择

URP提供了不同的渲染技术，每一种都有其优势和缺陷，如何选择这些渲染技术取决于项目的特定需求和限制。

|          | 原理                                                                                | 优点                                                          | 缺点                                                         |
| -------- | --------------------------------------------------------------------------------- | ----------------------------------------------------------- | ---------------------------------------------------------- |
| Forward  | 场景中的物体被逐一渲染，每一个像素单独计算。这意味着对于屏幕上的每一个像素，Unity都要对场景中的每一个对象计算光照和着色，以确定它们对像素最终颜色的贡献。   | 流程相对直接，易于理解，在光源较少和材质简单的场景中表现好。                              | 由于需要为场景中每一个光源使用多个通道处理，在面对大量光源和复杂材质的场景时可能比较低效。              |
| Forward+ | 将光源分组为集群，只有处于集群当中的物体才被纳入光照计算，而不是对所有物体逐一处理每一个光源。                                   | 相比于Forward渲染，尤其在大量光源的场景下有更好的性能，能通过减少需要计算光照的物体数量来更高效地利用硬件资源。 | 在极端大量光源和复杂场景下可能仍然表现不佳，并且要实现Forward+渲染需要做更多的优化工作。           |
| Deferred | 将光照和着色计算从几何渲染过程中解耦出来。首先将几何渲染到一个缓冲区集合（包含每一个像素的位置、法线和材质属性等信息）中，然后根据缓冲区数据进行逐像素的光照计算。 | 对于渲染大量光源或复杂材质的场景非常高效，因为光照是逐像素而不是逐对象计算的。                     | 由于需要存储额外的缓冲区，内存占用会增加。对透明物体的渲染有限制，以及在处理特定类型的光照效果时有困难（如体积光）。 |
## 用于光照场景的URP着色器

| Shader      | 描述                                                                                                              |
| ----------- | --------------------------------------------------------------------------------------------------------------- |
| Lit         | 以写实质量渲染真实世界中的表面，在各种光照条件下都能获得逼真的光影和反射效果。支持烘焙、混合以及实时光照，是大多数支持光照的材质的默认选项。使用的是基于物理的着色模型，由于其着色计算的复杂性，最好避免在低端移动设备上使用。 |
| Simple Lit  | 使用非能量守恒的Blinn-Phong着色模型，更适合非基于物理着色的项目以及低端移动设备。                                                                  |
| Complex Lit | 拥有Lit的所有特性，会计算两次高光反射（基础层和位于基础层之上的模拟的一层透明薄层）。当需要使用清漆选项实现汽车的金属光泽时，选择该着色器。                                         |
| Baked Lit   | 对于不需要实时光照的对象，例如永远不会受动态物体、实时光源和动态阴影影响的远处静态物体，使用该着色器可提高性能。                                                        |
## 照亮新场景

在URP中照亮一个新场景的第一步是创建一个新的光照设置资产，通过切换光照设置资产可以在不同光照设置之间切换。

## 环境光照

最主要的环境光是在Lighting面板中的Environment页签下配置的。

可以使用场景天空盒，设置强度、渐变或颜色来设置环境光照。Skybox模式要求按需烘焙来计算天空的环境探针，只有Gradient和Color模式会实时更新。

## 阴影

### 主光源阴影分辨率

实时阴影需要渲染一张包含光源视角的物体深度数据的阴影纹理，阴影纹理的分辨率越高，阴影的视觉保真度就越高，当然也需要更多的算力和内存。影响阴影计算的因素包括：

1. 渲染在阴影纹理中的阴影投射器数量，对于主光源，该数量取决于阴影距离（URP资产Shadows模块的Max Distance）
2. 可见的阴影接收者
3. 阴影级联分段（Shadow Cascades splits）
4. 阴影过滤（软阴影）

> [!NOTE] 阴影级联
> 方向光在摄像机附近产生的实时阴影会出现像素化的问题叫做透视走样，阴影级联可以解决该问题。

最高分辨率得到的效果并不总是最理想的，例如使用软阴影时，阴影贴图会被模糊，使用高分辨率的阴影贴图会导致阴影边缘过于清晰，得不到模糊效果。

### 主光源阴影最大距离

最大距离的单位和场景单位一样，当最大距离设置太大时，阴影贴图会分散在过大的区域，导致镜头内部分的贴图分辨率远低于需求。

最大距离需要根据玩家所能看到物体的最远距离来设置，也就是说如果玩家最远只能看到离摄像机60单位的阴影，那就将该数值设置为60。

当混合光源的光照模式设置为Shadowmask时，超出阴影最大距离的物体的阴影会被烘焙，只有动态阴影才会被最大距离限制。

### 阴影级联

物体由于透视消失在远处，可以降低远距离视野的阴影分辨率，将更多的资源用于处理靠近摄像机的阴影，这就是阴影级联的核心思想。

该技术的原理是将原来的单张阴影贴图拆分为多张贴图，拆分的逻辑是根据摄像机视锥体深度划分多个层次进行分割。每张级联贴图的覆盖范围和尺寸都不同，距离越近的贴图覆盖范围和尺寸越小，主要为近处物体提供更好的细节，距离越远的贴图覆盖范围和尺寸大，阴影相对模糊，因为远处阴影不需要细节（看不清）。相邻的级联之间会进行混合，以实现平滑过渡。

对于小场景，一个级联就可达到最佳效果。如果阴影最大距离非常大，那就需要两到三个级联。